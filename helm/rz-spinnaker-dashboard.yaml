apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    grafana_dashboard: "true"
  name: rz-spinnaker-dashboard
  namespace: default
data:
  rz-spinnaker-dashboard.json: '{"annotations":{"list":[{"builtIn":1,"datasource":"--
    Grafana --","enable":true,"hide":true,"iconColor":"rgba(0,211,255,1)","name":"Annotations&Alerts","type":"dashboard"}]},"description":"Metrics
    RZ cares about https://blog.spinnaker.io/monitoring-spinnaker-part-1-4847f42a3abd","editable":true,"gnetId":null,"graphTooltip":0,"id":29,"iteration":1562186060235,"links":[{"icon":"externallink","tags":[],"title":"SpinnakerMonitoringGuide","type":"link","url":"https://blog.spinnaker.io/monitoring-spinnaker-part-1-4847f42a3abd"}],"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"Prometheus","fill":1,"gridPos":{"h":7,"w":12,"x":0,"y":0},"id":6,"legend":{"avg":false,"current":false,"hideEmpty":true,"hideZero":true,"max":false,"min":false,"show":false,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{},"percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum($Function(orca:stage:invocations_total{application=~\"$Application\"}[$SamplePeriod]))by(application,type)","format":"time_series","hide":false,"intervalFactor":2,"legendFormat":"{{application}}/{{type}}","metric":"","refId":"B","step":10}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"ActiveStagesbyApplication(orca,$Application)","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":"0","show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":"0","show":true}],"yaxis":{"align":false,"alignLevel":null}},{"alert":{"conditions":[{"evaluator":{"params":[1],"type":"gt"},"operator":{"type":"and"},"query":{"params":["B","5m","now"]},"reducer":{"params":[],"type":"avg"},"type":"query"}],"executionErrorState":"alerting","for":"5m","frequency":"1m","handler":1,"message":"Prodorcalikelyneedsscalingasthereadytaskqueuehasbeenabove1onavgforpast5m.","name":"OrcaQueueDepthalert","noDataState":"no_data","notifications":[{"uid":"iavqax4Wk"}]},"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"description":"Spinnaker
    Orca queue depth. Ready queue should always be 0 or close to it. If not, scale
    Orca. I like this graph, especially when it looks like this. Keiko supports setting
    a delivery time for messages, so you’ll always see queued messages out pacing
    in-process messages if your Spinnaker install is active. Things like wait tasks,
    execution windows, retries, and so-on all schedule message delivery in the future,
    and in-process messages are usually in-process for a handful of milliseconds.
    Operating Orca, one of your life mission is to keep ready messages at 0. A ready
    message is a message that has a delivery time of now or in the past, but it hasn’t
    been picked up and transitioned into processing yet: This is a key contributor
    to a complaint of,''Spinnaker is slow.'' As I’ve mentioned before, Orca is horizontally
    scalable. Give Orca an adrenaline shot of instances if you see ready messages
    over 0 for more than two intervals so you can clear the queue out.","fill":1,"gridPos":{"h":8,"w":12,"x":12,"y":0},"id":4,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"orca:queue:unacked:depth","format":"time_series","intervalFactor":1,"legendFormat":"unacked({{pod}})","refId":"A"},{"expr":"orca:queue:ready:depth","format":"time_series","intervalFactor":1,"legendFormat":"ready({{pod}})","refId":"B"},{"expr":"orca:queue:depth","format":"time_series","intervalFactor":1,"legendFormat":"depth({{pod}})","refId":"C"}],"thresholds":[{"colorMode":"critical","fill":true,"line":true,"op":"gt","value":1}],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"OrcaQueueDepth","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"fill":1,"gridPos":{"h":8,"w":12,"x":0,"y":7},"id":12,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(orca:queue:message:lag__totalTime_total/orca:queue:message:lag__count_total)","format":"time_series","intervalFactor":1,"refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"MessageLag","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"description":"Spinnaker
    Orca tasks currently running grouped by application.","fill":1,"gridPos":{"h":8,"w":12,"x":12,"y":8},"id":2,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(orca:task:invocations:duration__count_total{status=\"RUNNING\",cloudProvider=\"kubernetes\"})by(application,executionType)","format":"time_series","intervalFactor":1,"legendFormat":"{{application}}{{executionType}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"OrcaRunningTasksTotalDurationbyApp","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"s","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"s","label":null,"logBase":1,"max":null,"min":null,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"description":"This
    is really just good insight for answering the question of workload distribution.
    Since adding this metric, we’ve never seen it crater, but if that were to happen
    it’d be bad. For Netflix, most ORCHESTRATION executions are API clients. Disregarding
    what the execution is doing, there’s no baseline cost difference between a running
    orchestration and a pipeline.","fill":1,"gridPos":{"h":8,"w":12,"x":0,"y":15},"id":10,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(orca:executions:active{})by(executionType)","format":"time_series","intervalFactor":1,"legendFormat":"{{executionType}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"ActiveOrcaExecutions","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"alert":{"conditions":[{"evaluator":{"params":[0],"type":"gt"},"operator":{"type":"and"},"query":{"params":["C","5m","now"]},"reducer":{"params":[],"type":"avg"},"type":"query"}],"executionErrorState":"alerting","for":"5m","frequency":"1m","handler":1,"message":"Orcahassomeorphanedqueuetasks.Thisshouldneverhappen.","name":"Retried,Dead,&OrphanedSpinQueuealert","noDataState":"no_data","notifications":[{"uid":"iavqax4Wk"}]},"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"description":"It
    sounds worse than it is. Retried is a normal error condition by itself. Dead-lettered
    occurs when a message has been retried a bunch of times and has never been successfully
    delivered. A dead message gets dropped into its own sorted set in Redis which,
    if you want, can be redriven with some Redis-fu, but there’s no current tooling
    around that. We know we need better tooling around dead messages — but we typically
    do not redrive messages. Orphaned messages are bad. They’re messages whose message
    contents are in the queue, but do not have a pointer in either the queue set or
    unacked set. This is a sign of an internal error, likely a troubling issue with
    Redis. It “should never happen” if your system is healthy, and likewise “should
    never happen” even if your system is really, really overloaded. It’s worth a bugreport.","fill":1,"gridPos":{"h":8,"w":12,"x":12,"y":16},"id":8,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"orca:queue:retried:messages_total","format":"time_series","intervalFactor":1,"legendFormat":"retried({{pod}})","refId":"A"},{"expr":"orca:queue:dead:messages_total","format":"time_series","intervalFactor":1,"legendFormat":"dead({{pod}})","refId":"B"},{"expr":"orca:queue:orphaned:messages","format":"time_series","intervalFactor":1,"legendFormat":"orphaned({{pod}})","refId":"C"}],"thresholds":[{"colorMode":"critical","fill":true,"line":true,"op":"gt","value":0}],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Retried,Dead,&OrphanedSpinQueue","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"refresh":"30s","schemaVersion":18,"style":"dark","tags":["spinnaker"],"templating":{"list":[{"allValue":null,"current":{"text":"delta","value":"delta"},"hide":0,"includeAll":false,"label":null,"multi":false,"name":"Function","options":[{"selected":true,"text":"delta","value":"delta"},{"selected":false,"text":"rate","value":"rate"},{"selected":false,"text":"idelta","value":"idelta"},{"selected":false,"text":"irate","value":"irate"}],"query":"delta,rate,idelta,irate","skipUrlSync":false,"type":"custom"},{"auto":false,"auto_count":30,"auto_min":"10s","current":{"text":"1m","value":"1m"},"hide":0,"label":"","name":"SamplePeriod","options":[{"selected":true,"text":"1m","value":"1m"},{"selected":false,"text":"5m","value":"5m"},{"selected":false,"text":"10m","value":"10m"},{"selected":false,"text":"15m","value":"15m"},{"selected":false,"text":"30m","value":"30m"},{"selected":false,"text":"1h","value":"1h"}],"query":"1m,5m,10m,15m,30m,1h","refresh":2,"skipUrlSync":false,"type":"interval"},{"allValue":".*","current":{"text":"All","value":"$__all"},"datasource":"Prometheus","definition":"label_values(orca:stage:invocations_total,application)","hide":0,"includeAll":true,"label":null,"multi":false,"name":"Application","options":[],"query":"label_values(orca:stage:invocations_total,application)","refresh":2,"regex":"","skipUrlSync":false,"sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false}]},"time":{"from":"now-3h","to":"now"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"","title":"RZSpinnakerDashboard","uid":"Bw9O-bVZk","version":9}'
